# 4.2 InnoDB 스토리지 엔진 아키텍처

## 4.2.1. 프라이머리 키에 의한 클러스터링

InnoDB는 클러스터 인덱스를 사용한다. 데이터 레코드가 프라이머리 키 값의 순서대로 디스크에 저장된다는 의미이며, 프라이머리 키를 찾으면 데이터를 찾은것이다. 보조 인덱스는 레코드의 주소 대신 프라이머리 키의 값을 논리적인 주소로 사용한다. 즉 보조 인덱스의 각 항목은 `(찾고 싶은 보조 인덱스 값 &rarr; PK 값)` 구조로 되어있다.  
보조 인덱스만 보면 실제 데이터는 나오지 않고 프라이머리 키 값만 나오기 때문에 PK 인덱스를 타고 데이터를 찾아야 한다. 이 과정을 Secondary Index Lookup + Primary Index Lookup 이라고 부른다.

프라이머리 키가 클러스터링 인덱스이기 때문에 프라이머리 키를 이용한 레인지 스캔은 빠르게 처리된다.

결과적으로 쿼리플랜에서 프라이머리 키는 보조 인덱스에 비해 우선순위가 높다 &rarr; 쿼리 플랜에서 보조 인덱스보다 프라이머리 키가 선택될 확률이 높다

반대로 MyISAM 스토리지 엔진은 클러스터링 키를 지원하지 않는다. 즉 프라이머리 키와 보조 인덱스는 구조적으로 아무런 차이가 없다. PK는 유니크 제약조건을 갖는 보조인덱스 개념이다. 따라서 프라이머리 키를 포함한 모든 인덱스는 물리적인 레코드 주소값(ROWID)를 갖는다.

## 4.2.6 자동화된 장애 복구

### 버퍼 풀

InnoDB 스토리지 엔진의 버퍼풀은 디스트의 데이터 파일이나 인덱스 정보를 메모리에 캐시해두고 쓰기 작업을 지연시켜 일괄적으로 디스크에 데이터를 저장하는 역할을 수행한다.

### 장애 복구

InnoDB에는 손실이나 장애로부터 데이터를 보호하기 위한 여러 가지 기능이 있는데, 대표적으로 MySQL 서버가 시작될 때 완료하지 못한 트랜잭션이나 디스크에 일부만 기록된(particial write) 데이터 페이지 등에 대한 일련 복구 작업을 자동으로 진행한다.

### 장애 복구 수행 방법

InnoDB의 자동 복구 과정은 다음과 같은 순서로 진행된다:

1. Redo Log 적용 (Roll-forward 복구)

리두 로그에는 디스크에는 반영되지 않았지만 커밋된 트랜잭션의 변경 이력이 기록되어 있다. 서버를 재시작 하면 InnoDB는 리두 로그를 순차적으로 읽어들인다. 커밋된 트랜잭션의 변경 내역이 디스크에 반영되지 않은 경우, 리두 로그를 통해 해당 내용을 재실행하여 테이블스페이스를 복구한다. 이를 통해 Durability가 보장된다.

2. Undo 로그 기반 복구 (Rollback)

이후 Undo Log를 활용하여 복구를 진행한다. 언두로그는 커밋되지 않은 트랜잭션의 변경 전 데이터를 저장하고 있다. 비정상 종료 시 커밋되지 않은 트랜잭션은 중단 상태로 남아있을 수 있다. InnoDB는 언두로그를 읽어 트랜잭션을 롤백한다. 이 과정을 통해 데이터의 일관성을 유지할 수 있다. 언두로그는 MVCC를 위한 이전 버전 데이터도 함께 제공하지만, 복구에서는 롤백 기능에 집중한다.

3. Doublewrite 버퍼 검증 및 복구

InnoDB는 Doublewrite Buffer라는 추가 보호 장치를 통해 Partial Page Write 문제를 방지한다. Partial Page Write란 OS나 디스크 등 하드웨어 이슈로 데이터의 페이지의 일부만 쓰여 데이터가 손상되는 현상을 의미한다. MySQL 서버를 재시작하면 InnoDB는 Doublewrite Buffer에 기록된 내용을 확인하고, 페이지가 손상되었지만 Doublewrite Buffer에는 정상적으로 존재하면 이를 사용해 페이지를 복구한다. 이를 통해 데이터 페이지의 물리적 무결성까지 보호할 수 있다.

### 하드웨어 이슈로 인한 장애

InnoDB엔진은 견고해서 데이터 파일이 손상되거나 MySQL 서버가 시작되지 못하는 경우가 드물지만, 하드웨어 이슈로 InnoDB 스토리지 엔진이 자동 복구 하지 못하는 경우가 발생할 수도 있다. InnoDB 데이터 파일은 MySQL 서버가 시작될 때 항상 자동복구를 수행하는데, 자동으로 복구할 수 없는 손상이 있다면 자동 복구를 멈추고 MySQL 서버는 종료된다.

이 경우는 `innodb_force_recovery` 시스템 변수를 설정해서 MySQL 서버를 시작해야 한다. 이 설정은 InnoDB가 데이터 파일이나 로그 파일의 손상 여부 검사 과정을 선별적으로 진행할 수 있게 한다.

